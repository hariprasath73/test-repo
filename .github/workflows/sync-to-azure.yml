name: Sync GitHub → Azure DevOps (Exact Branch Mirror Sync ✅)

on:
  workflow_dispatch:  # ✅ Manual trigger
  push:
    branches:
      - main           # ✅ Auto-sync on pushes to main branch (adjust as needed)
  schedule:
    - cron: '0 * * * *'  # ✅ Scheduled every hour (adjust if needed)

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout GitHub Repository (all branches)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ✅ Fetch entire history and all branches

    - name: Fetch All GitHub Branches and Push to Azure DevOps (Exact Mirror Sync)
      env:
        AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
        AZURE_DEVOPS_PROJECT: ${{ secrets.AZURE_DEVOPS_PROJECT }}
        AZURE_DEVOPS_REPO: ${{ secrets.AZURE_DEVOPS_REPO }}
      run: |
        git remote set-url origin "${{ github.repositoryUrl }}"
        git fetch --all

        AZURE_URL="https://$AZURE_DEVOPS_PAT@dev.azure.com/$AZURE_DEVOPS_ORG/$AZURE_DEVOPS_PROJECT/_git/$AZURE_DEVOPS_REPO"

        echo "Branches found:"
        git branch -r | awk '{print $1}'

        for branch in $(git branch -r | awk '{print $1}'); do
          case "$branch" in
            *'->'* ) continue ;;  # Skip symbolic refs like HEAD
          esac
          branch_name="${branch#origin/}"
          echo "Syncing branch: $branch_name"

          git checkout "$branch_name" || git checkout -b "$branch_name" "$branch"
          git push --force "$AZURE_URL" "refs/heads/$branch_name:refs/heads/$branch_name"
        done
