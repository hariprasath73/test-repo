name: Sync GitHub â†’ Azure DevOps

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout GitHub Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Test Network Connectivity (Debug)
      run: |
        ping -c 4 github.com || true
        curl -I https://github.com || true
        curl -I https://dev.azure.com || true

    - name: Set up Git Config
      run: |
        git config --global user.email "sync-bot@yourdomain.com"
        git config --global user.name "GitHub to Azure Sync Bot"

    - name: Clone Azure DevOps Repository
      env:
        AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
        AZURE_DEVOPS_PROJECT: ${{ secrets.AZURE_DEVOPS_PROJECT }}
        AZURE_DEVOPS_REPO: ${{ secrets.AZURE_DEVOPS_REPO }}
      run: |
        AZURE_URL="dev.azure.com/$AZURE_DEVOPS_ORG/$AZURE_DEVOPS_PROJECT/_git/$AZURE_DEVOPS_REPO"
        git clone --mirror "https://:$AZURE_DEVOPS_PAT@$AZURE_URL" azure_repo.git

        cd azure_repo.git
        git remote add github-origin "${{ github.repositoryUrl }}"
        git fetch github-origin --prune

        for branch in $(git for-each-ref --format='%(refname:short)' refs/remotes/github-origin/); do
          echo "Syncing branch: $branch"

          if git show-ref --quiet refs/heads/"${branch##github-origin/}"; then
            git checkout "${branch##github-origin/}"
          else
            git checkout -b "${branch##github-origin/}"
          fi

          git merge --allow-unrelated-histories --strategy=recursive --strategy-option=theirs "github-origin/$branch" -m "Merge GitHub branch '$branch' into Azure Repo"
          git push origin "${branch##github-origin/}"
        done

    - name: Cleanup
      run: rm -rf azure_repo.git
